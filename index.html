<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHOP EBENEZER</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --red-dark: #810f0f;
            --red-mid:  #ea666f;
            --green:    #28a745;
            --blue:     #007bff;
            --admin-color:    #810f0f;
            --deposit-color:  #1a7a35;
            --withdraw-color: #bd2130;
        }

        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--red-mid) 0%, var(--red-dark) 100%);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #loginScreen {
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            padding: clamp(12px, 3vw, 24px);
        }
        .login-wrapper {
            width: 100%; max-width: 360px;
            display: flex; flex-direction: column; align-items: center;
            gap: clamp(12px, 2.5vh, 22px);
        }
        .login-brand { text-align: center; color: white; }
        .brand-icon  { font-size: clamp(2rem, 5vw, 3rem); line-height: 1; }
        .brand-title { font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 900; letter-spacing: 2px; text-shadow: 0 2px 8px rgba(0,0,0,.3); margin-top: 4px; }
        .brand-sub   { font-size: clamp(.7rem, 2vw, .85rem); opacity: .8; margin-top: 4px; }
        .login-card  { background: white; border-radius: 20px; width: 100%; padding: clamp(18px,4vw,28px) clamp(16px,4vw,26px); box-shadow: 0 20px 60px rgba(0,0,0,.35); }
        .section-label { font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: #adb5bd; text-align: center; margin-bottom: 10px; }
        .role-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: clamp(14px,3vh,22px); }
        .role-card { display:flex; flex-direction:column; align-items:center; gap:5px; padding:clamp(10px,2vh,14px) 6px; border:2px solid #e9ecef; border-radius:12px; background:#f8f9fa; cursor:pointer; color:#6c757d; font-weight:700; font-size:clamp(.7rem,2vw,.8rem); transition:all .18s ease; user-select:none; -webkit-tap-highlight-color:transparent; }
        .role-card .rc-icon { font-size: clamp(1.4rem,4vw,1.8rem); line-height:1; }
        .role-card:hover { border-color:#ccc; background:#f0f0f0; }
        .role-card.active-admin    { border-color:var(--admin-color);    background:#fff0f0; color:var(--admin-color);    box-shadow:0 3px 10px rgba(129,15,15,.18); }
        .role-card.active-deposit  { border-color:var(--deposit-color);  background:#f0fff4; color:var(--deposit-color);  box-shadow:0 3px 10px rgba(26,122,53,.18); }
        .role-card.active-withdraw { border-color:var(--withdraw-color); background:#fff5f5; color:var(--withdraw-color); box-shadow:0 3px 10px rgba(189,33,48,.18); }
        .pin-divider { display:flex; align-items:center; gap:8px; margin-bottom:clamp(10px,2vh,16px); font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:#ced4da; }
        .pin-divider::before,.pin-divider::after { content:''; flex:1; height:1px; background:#e9ecef; }
        .pin-dots { display:flex; justify-content:center; gap:clamp(12px,4vw,20px); margin-bottom:clamp(6px,1.5vh,10px); }
        .pin-dot { width:clamp(14px,3.5vw,18px); height:clamp(14px,3.5vw,18px); border-radius:50%; border:2.5px solid #dee2e6; background:white; transition:all .15s ease; }
        .pin-dot.f-admin    { background:var(--admin-color);    border-color:var(--admin-color);    transform:scale(1.12); }
        .pin-dot.f-deposit  { background:var(--deposit-color);  border-color:var(--deposit-color);  transform:scale(1.12); }
        .pin-dot.f-withdraw { background:var(--withdraw-color); border-color:var(--withdraw-color); transform:scale(1.12); }
        .login-error { text-align:center; color:#dc3545; font-size:.78rem; font-weight:600; min-height:18px; margin-bottom:8px; }
        .pin-keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:clamp(6px,1.5vw,10px); }
        .key-btn { aspect-ratio:1.2; display:flex; align-items:center; justify-content:center; border:2px solid #e9ecef; border-radius:11px; background:#f8f9fa; font-size:clamp(1rem,3.5vw,1.3rem); font-weight:800; cursor:pointer; color:#2c3e50; transition:all .12s ease; user-select:none; -webkit-tap-highlight-color:transparent; }
        .key-btn:hover { background:#e9ecef; border-color:#ced4da; }
        .key-btn:active { transform:scale(.91); background:#dee2e6; }
        .key-btn.k-zero { grid-column:2; }
        .key-btn.k-del { background:#fff0f0; color:#dc3545; border-color:#f5c6cb; font-size:clamp(.95rem,3vw,1.1rem); }
        .key-btn.k-ok  { background:var(--red-dark); color:white; border-color:var(--red-dark); font-size:clamp(.95rem,3vw,1.1rem); }
        .key-btn.k-ok:hover { background:#6a0d0d; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
        .shake { animation:shake .36s ease; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #appScreen { display:none; min-height:100vh; padding:clamp(10px,2vw,20px); }
        .container  { max-width:1200px; margin:0 auto; background:white; border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,.22); overflow:hidden; }
        .app-header { background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:white; padding:24px 20px; text-align:center; position:relative; }
        .app-header h1 { font-size:clamp(1.5rem,4vw,2.4rem); margin-bottom:6px; }
        .app-header p  { opacity:.85; font-size:clamp(.8rem,2vw,1rem); }
        .user-badge  { position:absolute; top:14px; left:16px; background:rgba(255,255,255,.18); color:white; border:1.5px solid rgba(255,255,255,.35); padding:5px 12px; border-radius:8px; font-size:clamp(.7rem,2vw,.82rem); font-weight:700; }
        .logout-btn  { position:absolute; top:14px; right:16px; background:rgba(255,255,255,.18); color:white; border:1.5px solid rgba(255,255,255,.35); padding:5px 12px; border-radius:8px; cursor:pointer; font-size:clamp(.7rem,2vw,.82rem); font-weight:700; transition:all .2s; }
        .logout-btn:hover { background:rgba(255,255,255,.3); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .nav-tabs { display:flex; background:#f1f3f5; border-bottom:2px solid #dee2e6; overflow-x:auto; }
        .nav-tab  { flex:1; min-width:max-content; padding:13px 18px; border:none; background:transparent; cursor:pointer; font-weight:700; font-size:clamp(.78rem,2vw,.9rem); color:#6c757d; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .2s; white-space:nowrap; }
        .nav-tab:hover { color:#2c3e50; background:rgba(0,0,0,.03); }
        .nav-tab.active { color:var(--red-dark); border-bottom-color:var(--red-dark); background:white; }
        .tab-icon { margin-right:5px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE PANELS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .page-panel { display:none; }
        .page-panel.active { display:block; }
        .main-content { padding:clamp(16px,3vw,30px); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORMS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .forms-section { display:grid; grid-template-columns:1fr 1fr; gap:clamp(14px,2.5vw,28px); margin-bottom:clamp(20px,3vh,36px); }
        .form-card { background:#f8f9fa; border-radius:12px; padding:clamp(16px,2.5vw,24px); border:2px solid #e9ecef; transition:all .28s ease; position:relative; overflow:hidden; }
        .form-card:hover { border-color:var(--red-dark); transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.1); }
        .form-card h3 { color:#2c3e50; margin-bottom:18px; font-size:clamp(1rem,2.5vw,1.2rem); display:flex; align-items:center; gap:8px; }
        .deposit-icon::before    { content:"üí∞"; }
        .withdrawal-icon::before { content:"üí∏"; }
        .bank-stock-icon::before { content:"üè¶"; }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; margin-bottom:6px; font-weight:600; color:#495057; font-size:.88rem; }
        .form-group input, .form-group select, .form-group textarea {
            width:100%; padding:10px 13px; border:2px solid #dee2e6;
            border-radius:8px; font-size:clamp(.88rem,2.5vw,1rem); outline:none; transition:border-color .25s; font-family:inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.12); }
        .form-group textarea { resize:vertical; min-height:70px; }
        .btn { width:100%; padding:11px; border:none; border-radius:8px; font-size:clamp(.82rem,2vw,.95rem); font-weight:700; cursor:pointer; transition:all .22s; text-transform:uppercase; letter-spacing:.5px; }
        .btn-deposit    { background:#28a745; color:white; }
        .btn-deposit:hover    { background:#218838; transform:translateY(-1px); }
        .btn-withdrawal { background:#dc3545; color:white; }
        .btn-withdrawal:hover { background:#c82333; transform:translateY(-1px); }
        .btn-bank       { background:#007bff; color:white; }
        .btn-bank:hover       { background:#0069d9; transform:translateY(-1px); }
        .locked-overlay { position:absolute; inset:0; background:rgba(248,248,248,.95); border-radius:12px; display:none; flex-direction:column; align-items:center; justify-content:center; gap:7px; z-index:5; }
        .locked-overlay .lk-icon { font-size:2.4em; }
        .locked-overlay .lk-text { font-weight:800; color:#343a40; font-size:.95em; }
        .locked-overlay .lk-sub  { font-size:.75em; color:#adb5bd; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .stats-section { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:clamp(12px,2vw,18px); margin-bottom:clamp(20px,3vh,36px); }
        .stat-card { background:linear-gradient(135deg,var(--red-mid) 0%,var(--red-dark) 100%); color:white; padding:clamp(16px,2.5vw,22px); border-radius:12px; text-align:center; position:relative; overflow:hidden; }
        .stat-card::before { content:''; position:absolute; inset:0; background:rgba(255,255,255,.08); transform:translateX(-100%); transition:transform .28s; }
        .stat-card:hover::before { transform:translateX(0); }
        .stat-card h4      { font-size:clamp(.72rem,1.8vw,.85rem); margin-bottom:8px; opacity:.9; position:relative; z-index:1; }
        .stat-card .amount { font-size:clamp(1.3rem,3vw,1.7em); font-weight:800; position:relative; z-index:1; }
        .stat-card.green   { background:linear-gradient(135deg,#43b062 0%,#1a7a35 100%); }
        .stat-card.blue    { background:linear-gradient(135deg,#4e90e0 0%,#1456a3 100%); }
        .stat-card.orange  { background:linear-gradient(135deg,#f0884a 0%,#c75221 100%); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUSTOMER LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .customers-section { background:#f8f9fa; border-radius:12px; padding:clamp(16px,2.5vw,24px); margin-bottom:clamp(16px,2.5vh,26px); }
        .customers-section h3 { color:#2c3e50; margin-bottom:16px; font-size:clamp(1rem,2.5vw,1.25rem); }
        .customer-list { display:grid; gap:10px; }
        .customer-card { background:white; border-radius:8px; padding:clamp(12px,2vw,18px); border-left:4px solid #dee2e6; display:grid; grid-template-columns:1fr auto auto auto; align-items:center; gap:12px; }
        .customer-card.completed { border-left-color:#28a745; background:#f8fff8; }
        .customer-card.pending   { border-left-color:#dc3545; background:#fff8f8; }
        .customer-info h4 { margin-bottom:3px; color:#2c3e50; font-size:.95em; }
        .customer-info p  { color:#6c757d; font-size:.82em; }
        .customer-balance { text-align:right; }
        .balance-amount   { font-size:1.1em; font-weight:800; color:#2c3e50; }
        .balance-details  { font-size:.78em; color:#6c757d; margin-top:3px; }
        .status-indicator { font-size:1.3em; }
        .col-label { font-size:.68rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#adb5bd; margin-bottom:2px; }
        .col-paid     { color:#28a745; font-weight:800; font-size:1em; }
        .col-withdraw { color:#dc3545; font-weight:800; font-size:1em; }
        .col-balance  { color:#2c3e50; font-weight:800; font-size:1.05em; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRANSACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .transactions-section { background:#f8f9fa; border-radius:12px; padding:clamp(16px,2.5vw,24px); }
        .transactions-section h3 { color:#2c3e50; margin-bottom:16px; font-size:clamp(1rem,2.5vw,1.25rem); }
        .transaction-item { background:white; border-radius:7px; padding:clamp(10px,1.8vw,14px); margin-bottom:8px; border-left:3px solid #dee2e6; display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:12px; }
        .transaction-item.deposit    { border-left-color:#28a745; }
        .transaction-item.withdrawal { border-left-color:#dc3545; }
        .transaction-item.bank-stock { border-left-color:#007bff; }
        .transaction-details h5   { margin-bottom:2px; color:#2c3e50; font-size:.9em; }
        .transaction-details span { color:#6c757d; font-size:.78em; }
        .transaction-amount { font-weight:800; font-size:1em; }
        .transaction-amount.deposit    { color:#28a745; }
        .transaction-amount.withdrawal { color:#dc3545; }
        .transaction-amount.bank-stock { color:#007bff; }
        .no-data { text-align:center; color:#adb5bd; padding:32px; font-style:italic; font-size:.9em; }
        .clear-btn { background:#c72a3a; color:white; padding:9px 20px; border:none; border-radius:7px; cursor:pointer; margin-top:16px; font-weight:700; font-size:.88rem; transition:background .22s; }
        .clear-btn:hover { background:#921d1d; }
        .btn-delete-row { background:none; border:1.5px solid #f5c6cb; color:#dc3545; border-radius:6px; padding:4px 9px; font-size:.78rem; font-weight:700; cursor:pointer; transition:all .18s; white-space:nowrap; }
        .btn-delete-row:hover { background:#dc3545; color:white; border-color:#dc3545; }
        @keyframes fadeOut { to { opacity:0; transform:translateX(30px); max-height:0; padding:0; margin:0; overflow:hidden; } }
        .deleting { animation:fadeOut .3s ease forwards; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UNPAID BALANCE PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .search-bar-section { background:#f8f9fa; border-radius:12px; padding:clamp(14px,2.5vw,22px); margin-bottom:clamp(16px,2.5vh,26px); border:2px solid #e9ecef; }
        .search-bar-section h3 { color:#2c3e50; margin-bottom:14px; font-size:clamp(1rem,2.5vw,1.2rem); }
        .search-row { display:flex; gap:10px; flex-wrap:wrap; }
        .search-row input, .search-row select { flex:1; min-width:140px; padding:10px 13px; border:2px solid #dee2e6; border-radius:8px; font-size:clamp(.88rem,2.5vw,.95rem); outline:none; transition:border-color .25s; font-family:inherit; }
        .search-row input:focus, .search-row select:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.12); }
        .btn-search { padding:10px 22px; border:none; border-radius:8px; background:var(--red-dark); color:white; font-weight:700; font-size:.9rem; cursor:pointer; white-space:nowrap; transition:all .2s; }
        .btn-search:hover { background:#6a0d0d; }
        .btn-reset  { padding:10px 16px; border:2px solid #dee2e6; border-radius:8px; background:white; color:#6c757d; font-weight:700; font-size:.9rem; cursor:pointer; transition:all .2s; }
        .btn-reset:hover { background:#f0f0f0; }

        .unpaid-table-wrap { overflow-x:auto; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.07); }
        .unpaid-table { width:100%; border-collapse:collapse; background:white; }
        .unpaid-table th { background:linear-gradient(135deg,var(--red-mid),var(--red-dark)); color:white; padding:13px 14px; text-align:left; font-size:.82rem; text-transform:uppercase; letter-spacing:1px; }
        .unpaid-table td { padding:12px 14px; border-bottom:1px solid #f0f0f0; font-size:.9rem; vertical-align:middle; }
        .unpaid-table tr:hover td { background:#fff8f8; }
        .unpaid-table .td-name { font-weight:700; color:#2c3e50; }
        .unpaid-table .td-paid { color:#28a745; font-weight:700; }
        .unpaid-table .td-withdraw { color:#dc3545; font-weight:700; }
        .unpaid-table .td-balance { font-weight:800; font-size:1.05em; color:#810f0f; }
        .badge-unpaid { display:inline-block; background:#fff0f0; color:#dc3545; border:1.5px solid #f5c6cb; border-radius:20px; padding:2px 10px; font-size:.72rem; font-weight:700; }
        .badge-paid   { display:inline-block; background:#f0fff4; color:#28a745; border:1.5px solid #c3e6cb; border-radius:20px; padding:2px 10px; font-size:.72rem; font-weight:700; }
        .unpaid-summary { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:14px; margin-bottom:22px; }
        .summary-card { padding:16px 18px; border-radius:10px; border:2px solid #e9ecef; background:white; }
        .summary-card .sc-label { font-size:.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:700; color:#adb5bd; margin-bottom:6px; }
        .summary-card .sc-value { font-size:1.4em; font-weight:900; }
        .summary-card.red   { border-color:#f5c6cb; } .summary-card.red .sc-value { color:#dc3545; }
        .summary-card.green { border-color:#c3e6cb; } .summary-card.green .sc-value { color:#28a745; }
        .summary-card.dark  { border-color:#c9d0d8; } .summary-card.dark .sc-value { color:#2c3e50; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BANK STOCK PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .bank-section-top { display:grid; grid-template-columns:1fr 1fr; gap:clamp(14px,2.5vw,28px); margin-bottom:clamp(20px,3vh,36px); }
        .bank-stock-item { background:white; border-radius:8px; padding:clamp(12px,2vw,16px); border-left:4px solid #007bff; margin-bottom:10px; display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:12px; }
        .bank-stock-item h5 { color:#2c3e50; font-size:.95em; margin-bottom:2px; }
        .bank-stock-item span { color:#6c757d; font-size:.8em; }
        .bank-amount { color:#007bff; font-weight:800; font-size:1.1em; }
        .bank-section { background:#f0f7ff; border-radius:12px; padding:clamp(16px,2.5vw,24px); margin-bottom:clamp(16px,2.5vh,26px); border:2px solid #bee3f8; }
        .bank-section h3 { color:#1456a3; margin-bottom:16px; font-size:clamp(1rem,2.5vw,1.25rem); }
        .bank-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:14px; margin-bottom:22px; }
        .bank-stat { padding:16px; border-radius:10px; background:linear-gradient(135deg,#4e90e0,#1456a3); color:white; text-align:center; }
        .bank-stat h4 { font-size:.78rem; opacity:.9; margin-bottom:6px; }
        .bank-stat .bamt { font-size:1.5em; font-weight:800; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .charts-section { display:grid; grid-template-columns:1fr 1fr; gap:clamp(14px,2.5vw,28px); margin-bottom:clamp(20px,3vh,36px); }
        .chart-card { background:#f8f9fa; border-radius:12px; padding:clamp(16px,2.5vw,22px); border:2px solid #e9ecef; }
        .chart-card h3 { color:#2c3e50; margin-bottom:14px; font-size:clamp(.95rem,2.5vw,1.1rem); display:flex; align-items:center; gap:8px; }
        .chart-wrap { position:relative; width:100%; }
        canvas { display:block; width:100% !important; }
        .donut-legend { display:flex; gap:16px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
        .legend-item { display:flex; align-items:center; gap:6px; font-size:.82rem; font-weight:700; color:#495057; }
        .legend-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
        .chart-period { display:flex; gap:6px; margin-bottom:14px; }
        .period-btn { padding:4px 12px; border:2px solid #dee2e6; border-radius:20px; background:white; font-size:.75rem; font-weight:700; cursor:pointer; color:#6c757d; transition:all .18s; }
        .period-btn.active { background:var(--red-dark); color:white; border-color:var(--red-dark); }
        .no-chart-data { text-align:center; color:#adb5bd; padding:40px 0; font-style:italic; font-size:.88rem; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        @media(max-width:700px) {
            .forms-section      { grid-template-columns:1fr; }
            .bank-section-top   { grid-template-columns:1fr; }
            .charts-section     { grid-template-columns:1fr; }
            .customer-card      { grid-template-columns:1fr; text-align:center; }
            .transaction-item   { grid-template-columns:auto 1fr; }
            .transaction-item > div:nth-child(3),
            .transaction-item > div:nth-child(4) { display:none; }
            .user-badge, .logout-btn { font-size:.7rem; padding:4px 9px; top:10px; }
            .app-header h1 { font-size:1.4rem; }
            .nav-tab { padding:10px 12px; font-size:.75rem; }
        }
        @media(max-width:360px) {
            .role-card .rc-icon { font-size:1.2rem; }
            .role-card { font-size:.68rem; padding:8px 4px; }
        }
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF REPORT BUTTON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .pdf-report-bar {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .pdf-report-bar span {
            color: rgba(255,255,255,0.85);
            font-size: .82rem;
            font-weight: 600;
        }
        .btn-pdf {
            background: linear-gradient(135deg, #c0392b, #810f0f);
            color: white;
            border: none;
            padding: 9px 20px;
            border-radius: 8px;
            font-weight: 800;
            font-size: .88rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: all .22s;
            box-shadow: 0 3px 10px rgba(0,0,0,.3);
            letter-spacing: .4px;
        }
        .btn-pdf:hover { background: linear-gradient(135deg, #a93226, #6a0d0d); transform: translateY(-1px); box-shadow: 0 5px 16px rgba(0,0,0,.35); }
        .btn-pdf:active { transform: translateY(0); }
        .pdf-date-picker {
            padding: 7px 12px;
            border: 2px solid rgba(255,255,255,.25);
            border-radius: 8px;
            background: rgba(255,255,255,.1);
            color: white;
            font-size: .82rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
        }
        .pdf-date-picker:focus { border-color: rgba(255,255,255,.5); }
        .pdf-date-picker::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
    <div class="login-wrapper">
        <div class="login-brand">
            <div class="brand-icon">üè™</div>
            <div class="brand-title">SHOP EBENEZER</div>
            <div class="brand-sub">Secure Transaction Management</div>
        </div>
        <div class="login-card" id="loginCard">
            <div class="section-label">Select Your Role</div>
            <div class="role-grid">
                <div class="role-card active-admin" id="card-admin" onclick="selectRole('admin')">
                    <span class="rc-icon">üëë</span><span>Admin</span>
                </div>
                <div class="role-card" id="card-deposit" onclick="selectRole('deposit')">
                    <span class="rc-icon">üí∞</span><span>Deposit</span>
                </div>
                <div class="role-card" id="card-withdraw" onclick="selectRole('withdraw')">
                    <span class="rc-icon">üí∏</span><span>Withdraw</span>
                </div>
            </div>
            <div class="pin-divider">Enter PIN</div>
            <div class="pin-dots">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
            </div>
            <div class="login-error" id="loginError">&nbsp;</div>
            <div class="pin-keypad">
                <button class="key-btn" onclick="pressKey('1')">1</button>
                <button class="key-btn" onclick="pressKey('2')">2</button>
                <button class="key-btn" onclick="pressKey('3')">3</button>
                <button class="key-btn" onclick="pressKey('4')">4</button>
                <button class="key-btn" onclick="pressKey('5')">5</button>
                <button class="key-btn" onclick="pressKey('6')">6</button>
                <button class="key-btn" onclick="pressKey('7')">7</button>
                <button class="key-btn" onclick="pressKey('8')">8</button>
                <button class="key-btn" onclick="pressKey('9')">9</button>
                <button class="key-btn k-del" onclick="clearPin()">‚å´</button>
                <button class="key-btn k-zero" onclick="pressKey('0')">0</button>
                <button class="key-btn k-ok"  onclick="submitPin()">‚úì</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appScreen">
    <div class="container">
        <header class="app-header">
            <div class="user-badge" id="userBadge">üëë Admin</div>
            <h1>SHOP EBENEZER</h1>
            <p>Professional Transaction Management System</p>
            <button class="logout-btn" onclick="logout()">üîí Logout</button>
        </header>

        <!-- NAV TABS -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('tabMain')">
                <span class="tab-icon">üè†</span>Main Ledger
            </button>
            <button class="nav-tab" onclick="showTab('tabUnpaid')">
                <span class="tab-icon">üî¥</span>Unpaid Balances
            </button>
            <button class="nav-tab" onclick="showTab('tabBank')">
                <span class="tab-icon">üè¶</span>Bank Stock
            </button>
        </nav>

        <!-- PDF REPORT BAR -->
        <div class="pdf-report-bar">
            <span>üìã Daily Operations Summary</span>
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <label style="color:rgba(255,255,255,.75);font-size:.78rem;font-weight:600;">Date:</label>
                <input type="date" class="pdf-date-picker" id="pdfReportDate" title="Select date for report">
                <button class="btn-pdf" onclick="generateDailyPDF()">
                    üìÑ Download PDF Report
                </button>
            </div>
        </div>

        <!-- ‚ïê‚ïê PAGE: MAIN LEDGER ‚ïê‚ïê -->
        <div id="tabMain" class="page-panel active">
          <main class="main-content">

            <section class="forms-section">
                <!-- DEPOSIT -->
                <div class="form-card">
                    <div class="locked-overlay" id="depositLock">
                        <div class="lk-icon">üîí</div>
                        <div class="lk-text">Deposits Locked</div>
                        <div class="lk-sub">Requires Deposit or Admin PIN</div>
                    </div>
                    <h3 class="deposit-icon"> Record Deposit (Paid)</h3>
                    <form id="depositForm">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="depositCustomer" required placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="depositAmount" required placeholder="0.00" min="0.01" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="depositDate">
                        </div>
                        <button type="submit" class="btn btn-deposit">üí∞ Record Payment</button>
                    </form>
                </div>

                <!-- WITHDRAWAL -->
                <div class="form-card">
                    <div class="locked-overlay" id="withdrawalLock">
                        <div class="lk-icon">üîí</div>
                        <div class="lk-text">Withdrawals Locked</div>
                        <div class="lk-sub">Requires Withdrawal or Admin PIN</div>
                    </div>
                    <h3 class="withdrawal-icon"> Record Withdrawal</h3>
                    <form id="withdrawalForm">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="withdrawalCustomer" required placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label>Amount Withdrawn</label>
                            <input type="number" id="withdrawalAmount" required placeholder="0.00" min="0.01" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="withdrawalDate">
                        </div>
                        <button type="submit" class="btn btn-withdrawal">üí∏ Record Withdrawal</button>
                    </form>
                </div>
            </section>

            <section class="stats-section">
                <div class="stat-card green"><h4>Total Paid In</h4><div class="amount" id="totalReceived">$0.00</div></div>
                <div class="stat-card"><h4>Total Withdrawn</h4><div class="amount" id="totalWithdrawn">$0.00</div></div>
                <div class="stat-card orange"><h4>Outstanding Balance</h4><div class="amount" id="totalOutstanding">$0.00</div></div>
                <div class="stat-card blue"><h4>Active Customers</h4><div class="amount" id="activeCustomers">0</div></div>
            </section>

            <!-- CHARTS -->
            <section class="charts-section">
                <!-- Daily Bar Chart -->
                <div class="chart-card">
                    <h3>üìä Daily Activity</h3>
                    <div class="chart-period">
                        <button class="period-btn active" onclick="setChartPeriod(7,this)">7 Days</button>
                        <button class="period-btn" onclick="setChartPeriod(14,this)">14 Days</button>
                        <button class="period-btn" onclick="setChartPeriod(30,this)">30 Days</button>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="barChart" height="200"></canvas>
                        <div class="no-chart-data" id="barNoData" style="display:none;">No transactions yet to display.</div>
                    </div>
                    <div class="donut-legend" style="margin-top:10px;">
                        <div class="legend-item"><div class="legend-dot" style="background:#28a745;"></div>Deposits</div>
                        <div class="legend-item"><div class="legend-dot" style="background:#dc3545;"></div>Withdrawals</div>
                    </div>
                </div>

                <!-- Donut Pie Chart -->
                <div class="chart-card">
                    <h3>üç© Deposit vs Withdrawal %</h3>
                    <div class="chart-period">
                        <button class="period-btn active" onclick="setDonutPeriod(7,this)">7 Days</button>
                        <button class="period-btn" onclick="setDonutPeriod(30,this)">30 Days</button>
                        <button class="period-btn" onclick="setDonutPeriod(0,this)">All Time</button>
                    </div>
                    <div class="chart-wrap" style="max-width:220px;margin:0 auto;">
                        <canvas id="donutChart" height="220"></canvas>
                        <div class="no-chart-data" id="donutNoData" style="display:none;">No transactions yet.</div>
                    </div>
                    <div class="donut-legend">
                        <div class="legend-item"><div class="legend-dot" style="background:#28a745;"></div><span id="donutDepPct">0%</span> Paid</div>
                        <div class="legend-item"><div class="legend-dot" style="background:#dc3545;"></div><span id="donutWdrPct">0%</span> Withdrawn</div>
                    </div>
                    <div style="text-align:center;margin-top:8px;font-size:.8rem;color:#6c757d;" id="donutSubtitle"></div>
                </div>
            </section>

            <div style="display:none;" id="customerList"></div>
            <div style="display:none;" id="transactionHistory"></div>
            <button class="clear-btn" id="clearData" style="display:none;">üóëÔ∏è Clear All Data</button>

          </main>
        </div>

        <!-- ‚ïê‚ïê PAGE: UNPAID BALANCES ‚ïê‚ïê -->
        <div id="tabUnpaid" class="page-panel">
          <main class="main-content">
            <h2 style="color:#2c3e50;margin-bottom:20px;">üî¥ Unpaid Balances</h2>

            <!-- Search Bar -->
            <section class="search-bar-section">
                <h3>üîç Search Balances</h3>
                <div class="search-row">
                    <input type="text" id="searchName" placeholder="Search by customer name‚Ä¶" oninput="renderUnpaid()">
                    <input type="date" id="searchDateFrom" onchange="renderUnpaid()" title="Last transaction from date">
                    <input type="date" id="searchDateTo"   onchange="renderUnpaid()" title="Last transaction to date">
                    <select id="searchStatus" onchange="renderUnpaid()">
                        <option value="unpaid">Unpaid Only</option>
                        <option value="paid">Paid / Settled</option>
                        <option value="all">All Customers</option>
                    </select>
                    <button class="btn-reset" onclick="resetSearch()">‚úï Reset</button>
                </div>
            </section>

            <!-- Summary Cards -->
            <div class="unpaid-summary" id="unpaidSummary"></div>

            <!-- Table -->
            <div class="unpaid-table-wrap">
                <table class="unpaid-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Customer Name</th>
                            <th>Total Paid</th>
                            <th>Total Withdrawn</th>
                            <th>Outstanding Balance</th>
                            <th>Last Transaction</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="unpaidTableBody">
                        <tr><td colspan="7" class="no-data">No data found.</td></tr>
                    </tbody>
                </table>
            </div>
          </main>
        </div>

        <!-- ‚ïê‚ïê PAGE: BANK STOCK ‚ïê‚ïê -->
        <div id="tabBank" class="page-panel">
          <main class="main-content">
            <h2 style="color:#1456a3;margin-bottom:20px;">üè¶ New Stock from Bank</h2>

            <div class="bank-section-top">
                <!-- Add Bank Stock Form -->
                <div class="form-card">
                    <div class="locked-overlay" id="bankLock">
                        <div class="lk-icon">üîí</div>
                        <div class="lk-text">Bank Entry Locked</div>
                        <div class="lk-sub">Requires Admin PIN</div>
                    </div>
                    <h3 class="bank-stock-icon"> Add Bank Stock Entry</h3>
                    <form id="bankStockForm">
                        <div class="form-group">
                            <label>Item / Description</label>
                            <input type="text" id="bankItem" required placeholder="e.g. Cash from Bank, Stock Delivery">
                        </div>
                        <div class="form-group">
                            <label>Amount / Value</label>
                            <input type="number" id="bankAmount" required placeholder="0.00" min="0.01" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Source / Bank Name</label>
                            <input type="text" id="bankSource" placeholder="e.g. Stanbic Bank, Centenary Bank">
                        </div>
                        <div class="form-group">
                            <label>Date Received</label>
                            <input type="date" id="bankDate">
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="bankNotes" placeholder="Additional notes‚Ä¶"></textarea>
                        </div>
                        <button type="submit" class="btn btn-bank">üè¶ Add Bank Stock</button>
                    </form>
                </div>

                <!-- Bank Stats -->
                <div style="display:flex;flex-direction:column;gap:16px;">
                    <div class="bank-stats" id="bankStatsBox">
                        <div class="bank-stat"><h4>Total Bank Stock</h4><div class="bamt" id="bankTotal">$0.00</div></div>
                        <div class="bank-stat"><h4>Entries This Month</h4><div class="bamt" id="bankMonthCount">0</div></div>
                    </div>
                    <div class="bank-section" style="flex:1;">
                        <h3>üìã Recent Bank Entries</h3>
                        <div id="bankStockList"><div class="no-data">No bank stock entries yet.</div></div>
                    </div>
                </div>
            </div>

            <!-- All Bank Stock History -->
            <div class="bank-section">
                <h3>üìä Full Bank Stock History</h3>
                <div class="search-row" style="margin-bottom:16px;">
                    <input type="text" id="bankSearchItem" placeholder="Search item/source‚Ä¶" oninput="renderBankStock()">
                    <input type="date" id="bankSearchFrom" onchange="renderBankStock()">
                    <input type="date" id="bankSearchTo"   onchange="renderBankStock()">
                    <button class="btn-reset" onclick="resetBankSearch()">‚úï Reset</button>
                </div>
                <div class="unpaid-table-wrap">
                    <table class="unpaid-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Item / Description</th>
                                <th>Source / Bank</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Recorded By</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="bankHistoryBody">
                            <tr><td colspan="7" class="no-data">No entries yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

          </main>
        </div>

    </div><!-- /container -->
</div><!-- /appScreen -->

<!-- Back End-->>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONST ROLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES = {
    admin:    { pin:'1234', label:'üëë Admin',              canDeposit:true,  canWithdraw:true,  canClear:true,  canBank:true  },
    deposit:  { pin:'2580', label:'üí∞ Deposit Cashier',    canDeposit:true,  canWithdraw:false, canClear:false, canBank:false },
    withdraw: { pin:'3691', label:'üí∏ Withdrawal Cashier', canDeposit:false, canWithdraw:true,  canClear:false, canBank:false }
};

let currentRole    = 'admin';
let currentPin     = '';
let loggedInRole   = null;
let failedAttempts = 0;
const MAX_ATTEMPTS = 5;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectRole(role) {
    currentRole = role; currentPin = '';
    document.getElementById('loginError').innerHTML = '&nbsp;';
    updateDots();
    ['admin','deposit','withdraw'].forEach(r => {
        document.getElementById('card-'+r).className = 'role-card';
    });
    document.getElementById('card-'+role).classList.add('active-'+role);
}

function pressKey(digit) {
    if (currentPin.length >= 4) return;
    currentPin += digit; updateDots();
    if (currentPin.length === 4) setTimeout(submitPin, 200);
}
function clearPin() {
    currentPin = currentPin.slice(0,-1); updateDots();
    document.getElementById('loginError').innerHTML = '&nbsp;';
}
function updateDots() {
    for (let i=1;i<=4;i++) {
        const dot = document.getElementById('dot'+i);
        dot.className = i <= currentPin.length ? 'pin-dot f-'+currentRole : 'pin-dot';
    }
}
function submitPin() {
    if (currentPin.length < 4) { document.getElementById('loginError').textContent='Please enter all 4 digits.'; return; }
    if (failedAttempts >= MAX_ATTEMPTS) { document.getElementById('loginError').textContent='üîí Too many attempts. Please refresh.'; return; }
    const role = ROLES[currentRole];
    if (currentPin === role.pin) {
        loggedInRole=currentRole; failedAttempts=0;
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('appScreen').style.display='block';
        document.getElementById('userBadge').textContent=role.label;
        applyPermissions(role);
        ledger.updateDisplay();
        renderUnpaid();
        renderBankStock();
        setTimeout(renderCharts, 50);
    } else {
        failedAttempts++;
        currentPin=''; updateDots();
        const rem = MAX_ATTEMPTS-failedAttempts;
        document.getElementById('loginError').textContent = rem>0
            ? `‚ùå Incorrect PIN ‚Äî ${rem} attempt${rem!==1?'s':''} left`
            : 'üîí Account locked. Please refresh the page.';
        const card=document.getElementById('loginCard');
        card.classList.add('shake');
        setTimeout(()=>card.classList.remove('shake'),380);
    }
}

function applyPermissions(role) {
    document.getElementById('depositLock').style.display    = role.canDeposit  ? 'none':'flex';
    document.getElementById('withdrawalLock').style.display = role.canWithdraw ? 'none':'flex';
    document.getElementById('clearData').style.display      = role.canClear    ? 'inline-block':'none';
    document.getElementById('bankLock').style.display       = role.canBank     ? 'none':'flex';
}

function logout() {
    if (!confirm('Are you sure you want to logout?')) return;
    loggedInRole=null; currentPin=''; failedAttempts=0;
    ['depositLock','withdrawalLock','bankLock'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('clearData').style.display='none';
    selectRole('admin');
    document.getElementById('appScreen').style.display='none';
    document.getElementById('loginScreen').style.display='flex';
}

document.addEventListener('keydown', e=>{
    if (document.getElementById('loginScreen').style.display==='none') return;
    if (e.key>='0'&&e.key<='9') pressKey(e.key);
    else if (e.key==='Backspace') clearPin();
    else if (e.key==='Enter') submitPin();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(id) {
    document.querySelectorAll('.page-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
    if (id==='tabUnpaid') renderUnpaid();
    if (id==='tabBank')   renderBankStock();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEDGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class DigitalLedger {
    constructor() {
        this.customers    = this.load('customers')    || {};
        this.transactions = this.load('transactions') || [];
        this.bankStock    = this.load('bankStock')    || [];
        this.bindEvents();
    }
    bindEvents() {
        document.getElementById('depositForm').addEventListener('submit', e=>{
            e.preventDefault();
            if (loggedInRole && ROLES[loggedInRole].canDeposit) this.recordDeposit();
        });
        document.getElementById('withdrawalForm').addEventListener('submit', e=>{
            e.preventDefault();
            if (loggedInRole && ROLES[loggedInRole].canWithdraw) this.recordWithdrawal();
        });
        document.getElementById('bankStockForm').addEventListener('submit', e=>{
            e.preventDefault();
            if (loggedInRole && ROLES[loggedInRole].canBank) this.recordBankStock();
        });
        document.getElementById('clearData').addEventListener('click', ()=>{
            if (confirm('Clear ALL data? This cannot be undone.')) this.clearAll();
        });
    }

    recordDeposit() {
        const name   = document.getElementById('depositCustomer').value.trim();
        const amount = parseFloat(document.getElementById('depositAmount').value);
        const dateVal= document.getElementById('depositDate').value;
        if (!name||!amount||amount<=0) { alert('Please enter a valid name and amount.'); return; }
        if (!this.customers[name]) {
            this.customers[name]={name,totalReceived:0,totalWithdrawn:0,balance:0,transactions:[]};
        }
        this.customers[name].totalReceived+=amount;
        this.customers[name].balance+=amount;
        const ts = dateVal ? new Date(dateVal+'T12:00:00').toISOString() : new Date().toISOString();
        const tx = {id:Date.now(),customer:name,type:'deposit',amount,timestamp:ts,balance:this.customers[name].balance,by:loggedInRole};
        this.customers[name].transactions.push(tx);
        this.transactions.unshift(tx);
        this.save(); this.updateDisplay();
        document.getElementById('depositForm').reset();
        this.toast(`üí∞ Payment of ${fmt(amount)} recorded for ${name}`);
    }

    recordWithdrawal() {
        const name   = document.getElementById('withdrawalCustomer').value.trim();
        const amount = parseFloat(document.getElementById('withdrawalAmount').value);
        const dateVal= document.getElementById('withdrawalDate').value;
        if (!name||!amount||amount<=0) { alert('Please enter a valid name and amount.'); return; }
        if (!this.customers[name]) { alert('Customer not found. Please record a deposit first.'); return; }
        if (this.customers[name].balance < amount) { alert(`Insufficient balance. Available: ${fmt(this.customers[name].balance)}`); return; }
        this.customers[name].totalWithdrawn+=amount;
        this.customers[name].balance-=amount;
        const ts = dateVal ? new Date(dateVal+'T12:00:00').toISOString() : new Date().toISOString();
        const tx = {id:Date.now(),customer:name,type:'withdrawal',amount,timestamp:ts,balance:this.customers[name].balance,by:loggedInRole};
        this.customers[name].transactions.push(tx);
        this.transactions.unshift(tx);
        this.save(); this.updateDisplay();
        document.getElementById('withdrawalForm').reset();
        this.toast(`üí∏ Withdrawal of ${fmt(amount)} processed for ${name}`);
    }

    recordBankStock() {
        const item   = document.getElementById('bankItem').value.trim();
        const amount = parseFloat(document.getElementById('bankAmount').value);
        const source = document.getElementById('bankSource').value.trim();
        const dateVal= document.getElementById('bankDate').value;
        const notes  = document.getElementById('bankNotes').value.trim();
        if (!item||!amount||amount<=0) { alert('Please enter a valid item and amount.'); return; }
        const ts = dateVal ? new Date(dateVal+'T12:00:00').toISOString() : new Date().toISOString();
        const entry = {id:Date.now(),item,amount,source:source||'‚Äî',timestamp:ts,notes:notes||'',by:loggedInRole};
        this.bankStock.unshift(entry);
        this.save(); renderBankStock();
        document.getElementById('bankStockForm').reset();
        this.toast(`üè¶ Bank stock entry recorded: ${item} ‚Äî ${fmt(amount)}`);
    }

    updateDisplay() {
        let rec=0,wdr=0,active=0;
        Object.values(this.customers).forEach(c=>{
            rec+=c.totalReceived; wdr+=c.totalWithdrawn;
            if(c.balance>0) active++;
        });
        document.getElementById('totalReceived').textContent    = fmt(rec);
        document.getElementById('totalWithdrawn').textContent   = fmt(wdr);
        document.getElementById('totalOutstanding').textContent = fmt(rec-wdr);
        document.getElementById('activeCustomers').textContent  = active;

        const customers=Object.values(this.customers);
        const cl=document.getElementById('customerList');
        cl.innerHTML = !customers.length
            ? '<div class="no-data">No customers yet. Add a deposit to get started.</div>'
            : customers.sort((a,b)=>b.balance-a.balance).map(c=>`
                <div class="customer-card ${c.balance>0?'pending':'completed'}">
                    <div class="customer-info">
                        <h4>${c.name}</h4>
                        <p>${c.balance>0?'Balance pending':'Settled'}</p>
                    </div>
                    <div style="text-align:center;">
                        <div class="col-label">Paid</div>
                        <div class="col-paid">${fmt(c.totalReceived)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div class="col-label">Withdrawn</div>
                        <div class="col-withdraw">${fmt(c.totalWithdrawn)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div class="col-label">Balance</div>
                        <div class="col-balance">${fmt(c.balance)}</div>
                    </div>
                    <div class="status-indicator">${c.balance>0?'üî¥':'üü¢'}</div>
                </div>`).join('');

        const txEl=document.getElementById('transactionHistory');
        const icons={admin:'üëë',deposit:'üí∞',withdraw:'üí∏'};
        txEl.innerHTML = !this.transactions.length
            ? '<div class="no-data">No transactions yet.</div>'
            : this.transactions.slice(0,15).map(t=>{
                const date=new Date(t.timestamp).toLocaleString();
                const by=t.by?`<span style="font-size:.72em;color:#adb5bd;margin-left:4px;">${icons[t.by]||''}</span>`:'';
                const canDel = loggedInRole && ROLES[loggedInRole].canClear;
                const delBtn = canDel ? `<button class="btn-delete-row" onclick="deleteTransaction(${t.id})" title="Delete this transaction">üóëÔ∏è Del</button>` : '';
                return `<div class="transaction-item ${t.type}" id="tx-${t.id}">
                    <div style="font-size:1.15em;">${t.type==='deposit'?'üí∞':'üí∏'}</div>
                    <div class="transaction-details"><h5>${t.customer}${by}</h5><span>${date}</span></div>
                    <div class="transaction-amount ${t.type}">${t.type==='deposit'?'+':'-'}${fmt(t.amount)}</div>
                    <div style="font-size:.78em;color:#6c757d;">Bal: ${fmt(t.balance)}</div>
                    ${delBtn}
                </div>`;
            }).join('');

        renderUnpaid();
        renderCharts();
    }

    toast(msg) {
        const n=document.createElement('div');
        n.style.cssText=`position:fixed;top:18px;right:18px;background:#28a745;color:white;padding:13px 18px;border-radius:9px;box-shadow:0 4px 14px rgba(0,0,0,.18);z-index:99999;font-weight:600;font-size:.88rem;transition:all .3s;max-width:280px;`;
        n.textContent=msg;
        document.body.appendChild(n);
        setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateX(110%)'; setTimeout(()=>n.remove(),320); },3000);
    }

    clearAll() {
        this.customers={}; this.transactions=[];
        localStorage.removeItem('customers'); localStorage.removeItem('transactions');
        this.updateDisplay(); this.toast('All data cleared');
    }
    save() {
        localStorage.setItem('customers',    JSON.stringify(this.customers));
        localStorage.setItem('transactions', JSON.stringify(this.transactions));
        localStorage.setItem('bankStock',    JSON.stringify(this.bankStock));
    }
    load(key) {
        try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; }
    }
}

const ledger = new DigitalLedger();

function fmt(n) { return '$'+n.toFixed(2); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNPAID BALANCES PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUnpaid() {
    const nameQ   = (document.getElementById('searchName')?.value||'').toLowerCase().trim();
    const fromStr = document.getElementById('searchDateFrom')?.value;
    const toStr   = document.getElementById('searchDateTo')?.value;
    const status  = document.getElementById('searchStatus')?.value||'unpaid';

    const fromDate = fromStr ? new Date(fromStr) : null;
    const toDate   = toStr   ? new Date(toStr+'T23:59:59') : null;

    let customers = Object.values(ledger.customers);

    // Filter by status
    if (status==='unpaid') customers=customers.filter(c=>c.balance>0);
    else if (status==='paid') customers=customers.filter(c=>c.balance<=0);

    // Filter by name
    if (nameQ) customers=customers.filter(c=>c.name.toLowerCase().includes(nameQ));

    // Filter by last transaction date
    if (fromDate||toDate) {
        customers=customers.filter(c=>{
            const lastTx = c.transactions.slice(-1)[0];
            if (!lastTx) return false;
            const d = new Date(lastTx.timestamp);
            if (fromDate && d<fromDate) return false;
            if (toDate   && d>toDate)   return false;
            return true;
        });
    }

    // Summary
    const totalUnpaid = customers.filter(c=>c.balance>0).reduce((s,c)=>s+c.balance,0);
    const totalPaid   = customers.reduce((s,c)=>s+c.totalReceived,0);
    const totalWdr    = customers.reduce((s,c)=>s+c.totalWithdrawn,0);
    document.getElementById('unpaidSummary').innerHTML = `
        <div class="summary-card red"><div class="sc-label">Unpaid Balance</div><div class="sc-value">${fmt(totalUnpaid)}</div></div>
        <div class="summary-card green"><div class="sc-label">Total Paid</div><div class="sc-value">${fmt(totalPaid)}</div></div>
        <div class="summary-card dark"><div class="sc-label">Total Withdrawn</div><div class="sc-value">${fmt(totalWdr)}</div></div>
        <div class="summary-card dark"><div class="sc-label">Results</div><div class="sc-value">${customers.length}</div></div>
    `;

    const tbody = document.getElementById('unpaidTableBody');
    if (!customers.length) {
        tbody.innerHTML='<tr><td colspan="7"><div class="no-data">No customers match your search.</div></td></tr>';
        return;
    }

    customers.sort((a,b)=>b.balance-a.balance);
    tbody.innerHTML = customers.map((c,i)=>{
        const lastTx=c.transactions.slice(-1)[0];
        const lastDate=lastTx?new Date(lastTx.timestamp).toLocaleDateString():'‚Äî';
        const badge=c.balance>0
            ?`<span class="badge-unpaid">Unpaid</span>`
            :`<span class="badge-paid">Settled</span>`;
        return `<tr>
            <td>${i+1}</td>
            <td class="td-name">${c.name}</td>
            <td class="td-paid">${fmt(c.totalReceived)}</td>
            <td class="td-withdraw">${fmt(c.totalWithdrawn)}</td>
            <td class="td-balance">${fmt(c.balance)}</td>
            <td>${lastDate}</td>
            <td>${badge}</td>
        </tr>`;
    }).join('');
}

function resetSearch() {
    document.getElementById('searchName').value='';
    document.getElementById('searchDateFrom').value='';
    document.getElementById('searchDateTo').value='';
    document.getElementById('searchStatus').value='unpaid';
    renderUnpaid();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BANK STOCK PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBankStock() {
    const itemQ   = (document.getElementById('bankSearchItem')?.value||'').toLowerCase().trim();
    const fromStr = document.getElementById('bankSearchFrom')?.value;
    const toStr   = document.getElementById('bankSearchTo')?.value;
    const fromDate= fromStr?new Date(fromStr):null;
    const toDate  = toStr?new Date(toStr+'T23:59:59'):null;

    let entries=[...ledger.bankStock];
    if (itemQ) entries=entries.filter(e=>(e.item+e.source).toLowerCase().includes(itemQ));
    if (fromDate) entries=entries.filter(e=>new Date(e.timestamp)>=fromDate);
    if (toDate)   entries=entries.filter(e=>new Date(e.timestamp)<=toDate);

    // Stats
    const total=ledger.bankStock.reduce((s,e)=>s+e.amount,0);
    const now=new Date(); const thisMonth=ledger.bankStock.filter(e=>{const d=new Date(e.timestamp);return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth();});
    document.getElementById('bankTotal').textContent=fmt(total);
    document.getElementById('bankMonthCount').textContent=thisMonth.length;

    // Recent (sidebar)
    const recent=document.getElementById('bankStockList');
    if (!ledger.bankStock.length) {
        recent.innerHTML='<div class="no-data">No bank stock entries yet.</div>';
    } else {
        const canDel = loggedInRole && ROLES[loggedInRole].canBank;
        recent.innerHTML=ledger.bankStock.slice(0,5).map(e=>`
            <div class="bank-stock-item" id="bk-${e.id}">
                <div><h5>${e.item}</h5><span>${e.source} ¬∑ ${new Date(e.timestamp).toLocaleDateString()}</span></div>
                <div class="bank-amount">${fmt(e.amount)}</div>
                ${canDel?`<button class="btn-delete-row" onclick="deleteBankStock(${e.id})" title="Delete entry">üóëÔ∏è</button>`:''}
            </div>`).join('');
    }

    // History table
    const tbody=document.getElementById('bankHistoryBody');
    const icons={admin:'üëë',deposit:'üí∞',withdraw:'üí∏'};
    if (!entries.length) {
        tbody.innerHTML='<tr><td colspan="8"><div class="no-data">No entries match your search.</div></td></tr>';
        return;
    }
    const canDel = loggedInRole && ROLES[loggedInRole].canBank;
    tbody.innerHTML=entries.map((e,i)=>`<tr id="bkr-${e.id}">
        <td>${i+1}</td>
        <td><strong>${e.item}</strong></td>
        <td>${e.source}</td>
        <td class="td-paid">${fmt(e.amount)}</td>
        <td>${new Date(e.timestamp).toLocaleDateString()}</td>
        <td>${e.by?icons[e.by]+' '+e.by:'‚Äî'}</td>
        <td style="color:#6c757d;font-size:.85em;">${e.notes||'‚Äî'}</td>
        <td>${canDel?`<button class="btn-delete-row" onclick="deleteBankStock(${e.id})">üóëÔ∏è Delete</button>`:''}</td>
    </tr>`).join('');
}

function resetBankSearch() {
    document.getElementById('bankSearchItem').value='';
    document.getElementById('bankSearchFrom').value='';
    document.getElementById('bankSearchTo').value='';
    renderBankStock();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let barDays   = 7;
let donutDays = 7;

function setChartPeriod(days, btn) {
    barDays = days;
    document.querySelectorAll('#tabMain .chart-card:first-child .period-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderCharts();
}
function setDonutPeriod(days, btn) {
    donutDays = days;
    document.querySelectorAll('#tabMain .chart-card:last-child .period-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderCharts();
}

function renderCharts() {
    renderBarChart();
    renderDonutChart();
}

function getDayLabel(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
}
function isSameDay(a, b) {
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function renderBarChart() {
    const canvas = document.getElementById('barChart');
    const noData = document.getElementById('barNoData');
    const ctx    = canvas.getContext('2d');
    const days   = barDays;

    // Build day buckets
    const buckets = [];
    for (let i = days-1; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate()-i);
        buckets.push({ date:d, label:getDayLabel(i), dep:0, wdr:0 });
    }

    ledger.transactions.forEach(t => {
        const td = new Date(t.timestamp);
        const b  = buckets.find(bk => isSameDay(bk.date, td));
        if (!b) return;
        if (t.type==='deposit')    b.dep += t.amount;
        if (t.type==='withdrawal') b.wdr += t.amount;
    });

    const total = buckets.reduce((s,b)=>s+b.dep+b.wdr,0);
    if (total===0) { canvas.style.display='none'; noData.style.display='block'; return; }
    canvas.style.display='block'; noData.style.display='none';

    const maxVal = Math.max(...buckets.map(b=>Math.max(b.dep,b.wdr)), 1);
    const dpr    = window.devicePixelRatio||1;
    const W      = canvas.parentElement.clientWidth;
    const H      = 200;
    canvas.width  = W*dpr; canvas.height = H*dpr;
    canvas.style.width=W+'px'; canvas.style.height=H+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const padL=36, padR=10, padT=14, padB=38;
    const chartW = W-padL-padR;
    const chartH = H-padT-padB;
    const groupW = chartW / buckets.length;
    const barW   = Math.min(groupW*0.35, 18);

    ctx.clearRect(0,0,W,H);

    // Grid lines
    ctx.strokeStyle='#e9ecef'; ctx.lineWidth=1;
    for (let g=0;g<=4;g++) {
        const y = padT + chartH - (chartH/4)*g;
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
        ctx.fillStyle='#adb5bd'; ctx.font=`${Math.max(9,10)}px Segoe UI`;
        ctx.textAlign='right';
        ctx.fillText('$'+(maxVal/4*g).toFixed(0), padL-4, y+4);
    }

    buckets.forEach((b,i) => {
        const x     = padL + groupW*i + groupW/2;
        const depH  = (b.dep/maxVal)*chartH;
        const wdrH  = (b.wdr/maxVal)*chartH;
        const r     = 3;

        // Deposit bar (green)
        const dx = x - barW - 2;
        const dy = padT + chartH - depH;
        if (b.dep > 0) {
            ctx.fillStyle = '#28a745';
            roundRect(ctx, dx, dy, barW, depH, [r,r,0,0]);
            ctx.fill();
        } else {
            ctx.fillStyle='#e9ecef';
            ctx.fillRect(dx, padT+chartH-2, barW, 2);
        }

        // Withdrawal bar (red)
        const wx = x + 2;
        const wy = padT + chartH - wdrH;
        if (b.wdr > 0) {
            ctx.fillStyle = '#dc3545';
            roundRect(ctx, wx, wy, barW, wdrH, [r,r,0,0]);
            ctx.fill();
        } else {
            ctx.fillStyle='#e9ecef';
            ctx.fillRect(wx, padT+chartH-2, barW, 2);
        }

        // X label
        ctx.fillStyle='#6c757d';
        ctx.font=`${Math.max(8,9)}px Segoe UI`;
        ctx.textAlign='center';
        const lbl = days<=7 ? b.label : (i%Math.ceil(days/7)===0 ? b.label : '');
        ctx.fillText(lbl, x, padT+chartH+16);
    });
}

function roundRect(ctx, x, y, w, h, radii) {
    const [tl,tr,br,bl] = radii;
    ctx.beginPath();
    ctx.moveTo(x+tl, y);
    ctx.lineTo(x+w-tr, y); ctx.arcTo(x+w,y, x+w,y+tr, tr);
    ctx.lineTo(x+w, y+h-br); ctx.arcTo(x+w,y+h, x+w-br,y+h, br);
    ctx.lineTo(x+bl, y+h); ctx.arcTo(x,y+h, x,y+h-bl, bl);
    ctx.lineTo(x, y+tl); ctx.arcTo(x,y, x+tl,y, tl);
    ctx.closePath();
}

function renderDonutChart() {
    const canvas  = document.getElementById('donutChart');
    const noData  = document.getElementById('donutNoData');
    const ctx     = canvas.getContext('2d');
    const days    = donutDays;

    let dep=0, wdr=0;
    const cutoff = days>0 ? Date.now()-days*86400000 : 0;
    ledger.transactions.forEach(t => {
        if (days>0 && new Date(t.timestamp).getTime()<cutoff) return;
        if (t.type==='deposit')    dep+=t.amount;
        if (t.type==='withdrawal') wdr+=t.amount;
    });

    const total = dep+wdr;
    document.getElementById('donutSubtitle').textContent =
        days===0 ? `All time ¬∑ ${fmt(total)} total` : `Last ${days} days ¬∑ ${fmt(total)} total`;

    if (total===0) {
        canvas.style.display='none'; noData.style.display='block';
        document.getElementById('donutDepPct').textContent='0%';
        document.getElementById('donutWdrPct').textContent='0%';
        return;
    }
    canvas.style.display='block'; noData.style.display='none';

    const depPct = dep/total;
    const wdrPct = wdr/total;
    document.getElementById('donutDepPct').textContent = (depPct*100).toFixed(1)+'%';
    document.getElementById('donutWdrPct').textContent = (wdrPct*100).toFixed(1)+'%';

    const dpr = window.devicePixelRatio||1;
    const S   = Math.min(canvas.parentElement.clientWidth, 220);
    canvas.width=S*dpr; canvas.height=S*dpr;
    canvas.style.width=S+'px'; canvas.style.height=S+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const cx=S/2, cy=S/2, outer=S/2-10, inner=outer*0.58;
    const startAngle = -Math.PI/2;

    // Deposit arc
    const depAngle = 2*Math.PI*depPct;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,outer, startAngle, startAngle+depAngle);
    ctx.closePath();
    // donut hole
    ctx.save();
    ctx.fillStyle='#28a745';
    // Use arc approach for donut
    ctx.restore();

    // Draw as donut arcs
    function donutArc(start, end, color) {
        ctx.beginPath();
        ctx.arc(cx,cy,outer,start,end);
        ctx.arc(cx,cy,inner,end,start,true);
        ctx.closePath();
        ctx.fillStyle=color;
        ctx.fill();
    }

    const gap = 0.03;
    donutArc(startAngle+gap/2, startAngle+depAngle-gap/2, '#28a745');
    donutArc(startAngle+depAngle+gap/2, startAngle+2*Math.PI-gap/2, '#dc3545');

    // Center text
    ctx.fillStyle='#2c3e50';
    ctx.font=`bold ${Math.round(S*0.09)}px Segoe UI`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(fmt(total), cx, cy-8);
    ctx.font=`${Math.round(S*0.065)}px Segoe UI`;
    ctx.fillStyle='#6c757d';
    ctx.fillText('Total', cx, cy+S*0.09);
}

// Redraw on resize
window.addEventListener('resize', ()=>{ if(loggedInRole) renderCharts(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE SINGLE TRANSACTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function deleteTransaction(id) {
    if (!loggedInRole || !ROLES[loggedInRole].canClear) {
        alert('Only Admin can delete transactions.'); return;
    }
    const tx = ledger.transactions.find(t=>t.id===id);
    if (!tx) return;
    if (!confirm(`Delete this ${tx.type} of ${fmt(tx.amount)} for "${tx.customer}"?\n\nThis will reverse their balance.`)) return;

    // Reverse the effect on the customer
    const c = ledger.customers[tx.customer];
    if (c) {
        if (tx.type==='deposit') {
            c.totalReceived -= tx.amount;
            c.balance       -= tx.amount;
        } else if (tx.type==='withdrawal') {
            c.totalWithdrawn -= tx.amount;
            c.balance        += tx.amount;
        }
        // Also remove from customer's own transaction list
        c.transactions = c.transactions.filter(t=>t.id!==id);
        // If customer has no transactions left, remove them
        if (c.transactions.length===0) {
            delete ledger.customers[tx.customer];
        }
    }

    // Remove from global transactions
    ledger.transactions = ledger.transactions.filter(t=>t.id!==id);

    // Animate out then refresh
    const el = document.getElementById('tx-'+id);
    if (el) {
        el.classList.add('deleting');
        setTimeout(()=>{ ledger.save(); ledger.updateDisplay(); }, 320);
    } else {
        ledger.save(); ledger.updateDisplay();
    }
    ledger.toast(`üóëÔ∏è Transaction deleted and balance reversed for ${tx.customer}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DAILY PDF REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Set today's date as default when app loads
document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('pdfReportDate');
    if (dateInput) dateInput.value = new Date().toISOString().slice(0,10);
});

function generateDailyPDF() {
    const dateInput = document.getElementById('pdfReportDate');
    const reportDate = dateInput.value || new Date().toISOString().slice(0,10);

    // Filter transactions for the selected date
    // Transactions store a 'timestamp' (ISO string), not a 'date' field ‚Äî extract date portion for comparison
    const txDate = t => t.date || (t.timestamp ? t.timestamp.slice(0, 10) : '');
    const dayTx = ledger.transactions.filter(t => txDate(t) === reportDate);
    const dayDeposits    = dayTx.filter(t => t.type === 'deposit');
    const dayWithdrawals = dayTx.filter(t => t.type === 'withdrawal');
    const dayBank        = (ledger.bankStock || []).filter(b => (b.date || (b.timestamp ? b.timestamp.slice(0, 10) : '')) === reportDate);

    const totalDep = dayDeposits.reduce((s, t) => s + t.amount, 0);
    const totalWdr = dayWithdrawals.reduce((s, t) => s + t.amount, 0);
    const netFlow  = totalDep - totalWdr;
    const totalBank= dayBank.reduce((s, b) => s + b.amount, 0);

    // Format helpers
    const fmtAmt = v => '$' + v.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    const fmtDate = d => {
        if (!d) return '';
        const [y,m,dy] = d.split('-');
        return `${dy}/${m}/${y}`;
    };
    const displayDate = fmtDate(reportDate);

    // ‚îÄ‚îÄ Build PDF using jsPDF ‚îÄ‚îÄ
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });

    const pageW = 210;
    const pageH = 297;
    const margin = 14;
    const col = pageW - margin*2;
    let y = 0;

    // Helper: add page if needed
    const checkPage = (need=10) => {
        if (y + need > pageH - 14) { doc.addPage(); y = 20; }
    };

    // ‚îÄ‚îÄ HEADER BANNER ‚îÄ‚îÄ
    doc.setFillColor(44, 62, 80);
    doc.rect(0, 0, pageW, 36, 'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(20); doc.setFont('helvetica','bold');
    doc.text('SHOP EBENEZER', pageW/2, 13, {align:'center'});
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Professional Transaction Management System', pageW/2, 19, {align:'center'});
    doc.setFillColor(129, 15, 15);
    doc.rect(0, 22, pageW, 14, 'F');
    doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text(`DAILY OPERATIONS SUMMARY ‚Äî ${displayDate}`, pageW/2, 31, {align:'center'});

    y = 44;

    // ‚îÄ‚îÄ GENERATED INFO ‚îÄ‚îÄ
    doc.setTextColor(100,100,100);
    doc.setFontSize(7.5); doc.setFont('helvetica','normal');
    doc.text(`Generated by: ${loggedInRole ? ROLES[loggedInRole].label.replace(/[^\w\s]/gi,'').trim() : 'System'}`, margin, y);
    doc.text(`Printed: ${new Date().toLocaleString()}`, pageW - margin, y, {align:'right'});
    y += 8;

    // ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ
    const drawDivider = (color=[200,200,200]) => {
        doc.setDrawColor(...color); doc.setLineWidth(0.4);
        doc.line(margin, y, pageW-margin, y);
        y += 4;
    };
    drawDivider();

    // ‚îÄ‚îÄ SUMMARY CARDS ROW ‚îÄ‚îÄ
    const cards = [
        { label:'Total Deposits', value: fmtAmt(totalDep), color:[39,174,96] },
        { label:'Total Withdrawals', value: fmtAmt(totalWdr), color:[192,57,43] },
        { label:'Net Cash Flow', value: fmtAmt(Math.abs(netFlow)) + (netFlow < 0 ? ' (-)' : ' (+)'), color: netFlow>=0 ? [41,128,185] : [155,89,182] },
        { label:'Bank Stock In', value: fmtAmt(totalBank), color:[23,162,184] },
    ];
    const cw = (col - 6) / 4;
    cards.forEach((c, i) => {
        const cx = margin + i*(cw+2);
        doc.setFillColor(...c.color);
        doc.roundedRect(cx, y, cw, 22, 2, 2, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(7); doc.setFont('helvetica','bold');
        doc.text(c.label.toUpperCase(), cx + cw/2, y+7, {align:'center'});
        doc.setFontSize(9); doc.setFont('helvetica','bold');
        const lines = doc.splitTextToSize(c.value, cw-4);
        doc.text(lines[0], cx + cw/2, y+15, {align:'center'});
    });
    y += 28;

    // ‚îÄ‚îÄ SECTION: DEPOSITS ‚îÄ‚îÄ
    const drawSectionHeader = (title, color=[129,15,15]) => {
        checkPage(14);
        doc.setFillColor(...color);
        doc.roundedRect(margin, y, col, 9, 1.5, 1.5, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(9.5); doc.setFont('helvetica','bold');
        doc.text(title, margin+4, y+6.3);
        y += 13;
        doc.setTextColor(50,50,50);
    };

    const drawTableHeader = (cols) => {
        doc.setFillColor(240,240,240);
        doc.rect(margin, y, col, 7, 'F');
        doc.setTextColor(80,80,80); doc.setFontSize(7.5); doc.setFont('helvetica','bold');
        let cx = margin + 2;
        cols.forEach(c => {
            doc.text(c.label, cx + (c.w/2), y + 5, {align: c.align||'center', maxWidth: c.w});
            cx += c.w;
        });
        y += 7;
        doc.setDrawColor(200,200,200); doc.setLineWidth(0.2);
        doc.line(margin, y, pageW-margin, y);
        y += 2;
    };

    const drawRow = (cols, values, rowIndex) => {
        checkPage(9);
        if (rowIndex % 2 === 0) { doc.setFillColor(252,252,252); doc.rect(margin, y, col, 8, 'F'); }
        doc.setTextColor(40,40,40); doc.setFontSize(7.8); doc.setFont('helvetica','normal');
        let cx = margin + 2;
        cols.forEach((c, i) => {
            const txt = String(values[i] ?? '');
            doc.text(txt, cx + (c.align==='right' ? c.w-4 : c.w/2), y+5.5, {align: c.align||'center', maxWidth: c.w-2});
            cx += c.w;
        });
        doc.setDrawColor(230,230,230); doc.setLineWidth(0.15);
        doc.line(margin, y+8, pageW-margin, y+8);
        y += 8;
    };

    // Deposits section
    drawSectionHeader(`üí∞ DEPOSITS  (${dayDeposits.length} transaction${dayDeposits.length!==1?'s':''})`, [39,174,96]);
    if (dayDeposits.length === 0) {
        doc.setTextColor(160,160,160); doc.setFontSize(8); doc.setFont('helvetica','italic');
        doc.text('No deposits recorded for this date.', margin+4, y+4);
        y += 10;
    } else {
        const depCols = [
            {label:'#',       w:8,   align:'center'},
            {label:'Customer',w:52,  align:'left'},
            {label:'Amount',  w:38,  align:'right'},
            {label:'Recorded By', w:38, align:'center'},
            {label:'Time / ID',   w:46, align:'center'},
        ];
        drawTableHeader(depCols);
        dayDeposits.forEach((t, i) => {
            drawRow(depCols, [
                i+1,
                t.customer,
                fmtAmt(t.amount),
                (t.by ? (ROLES[t.by] ? ROLES[t.by].label.replace(/[^\w\s]/gi,'').trim() : t.by) : 'N/A'),
                t.id ? String(t.id).slice(-8) : '‚Äî'
            ], i);
        });
        // Subtotal
        y += 2;
        doc.setFillColor(39,174,96); doc.setTextColor(255,255,255);
        doc.roundedRect(margin, y, col, 8, 1, 1, 'F');
        doc.setFontSize(8.5); doc.setFont('helvetica','bold');
        doc.text('TOTAL DEPOSITS:', margin+4, y+5.5);
        doc.text(fmtAmt(totalDep), pageW-margin-4, y+5.5, {align:'right'});
        y += 13;
    }

    // Withdrawals section
    drawSectionHeader(`üí∏ WITHDRAWALS  (${dayWithdrawals.length} transaction${dayWithdrawals.length!==1?'s':''})`, [192,57,43]);
    if (dayWithdrawals.length === 0) {
        doc.setTextColor(160,160,160); doc.setFontSize(8); doc.setFont('helvetica','italic');
        doc.text('No withdrawals recorded for this date.', margin+4, y+4);
        y += 10;
    } else {
        const wdrCols = [
            {label:'#',       w:8,   align:'center'},
            {label:'Customer',w:52,  align:'left'},
            {label:'Amount',  w:38,  align:'right'},
            {label:'Recorded By', w:38, align:'center'},
            {label:'Time / ID',   w:46, align:'center'},
        ];
        drawTableHeader(wdrCols);
        dayWithdrawals.forEach((t, i) => {
            drawRow(wdrCols, [
                i+1,
                t.customer,
                fmtAmt(t.amount),
                (t.by ? (ROLES[t.by] ? ROLES[t.by].label.replace(/[^\w\s]/gi,'').trim() : t.by) : 'N/A'),
                t.id ? String(t.id).slice(-8) : '‚Äî'
            ], i);
        });
        y += 2;
        doc.setFillColor(192,57,43); doc.setTextColor(255,255,255);
        doc.roundedRect(margin, y, col, 8, 1, 1, 'F');
        doc.setFontSize(8.5); doc.setFont('helvetica','bold');
        doc.text('TOTAL WITHDRAWALS:', margin+4, y+5.5);
        doc.text(fmtAmt(totalWdr), pageW-margin-4, y+5.5, {align:'right'});
        y += 13;
    }

    // Bank Stock section
    checkPage(20);
    drawSectionHeader(`üè¶ BANK STOCK RECEIVED  (${dayBank.length} entr${dayBank.length!==1?'ies':'y'})`, [23,100,170]);
    if (dayBank.length === 0) {
        doc.setTextColor(160,160,160); doc.setFontSize(8); doc.setFont('helvetica','italic');
        doc.text('No bank stock entries for this date.', margin+4, y+4);
        y += 10;
    } else {
        const bkCols = [
            {label:'#',       w:8,   align:'center'},
            {label:'Item / Description', w:54, align:'left'},
            {label:'Source / Bank',w:42, align:'center'},
            {label:'Amount',  w:38,  align:'right'},
            {label:'Notes',   w:40,  align:'left'},
        ];
        drawTableHeader(bkCols);
        dayBank.forEach((b, i) => {
            drawRow(bkCols, [i+1, b.item||'', b.source||'', fmtAmt(b.amount), b.notes||''], i);
        });
        y += 2;
        doc.setFillColor(23,100,170); doc.setTextColor(255,255,255);
        doc.roundedRect(margin, y, col, 8, 1, 1, 'F');
        doc.setFontSize(8.5); doc.setFont('helvetica','bold');
        doc.text('TOTAL BANK STOCK:', margin+4, y+5.5);
        doc.text(fmtAmt(totalBank), pageW-margin-4, y+5.5, {align:'right'});
        y += 13;
    }

    // ‚îÄ‚îÄ NET FLOW BOX ‚îÄ‚îÄ
    checkPage(24);
    drawDivider();
    const netColor = netFlow >= 0 ? [39,174,96] : [192,57,43];
    doc.setFillColor(...netColor);
    doc.roundedRect(margin, y, col, 18, 2.5, 2.5, 'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('NET CASH FLOW FOR THE DAY', margin+6, y+7);
    doc.setFontSize(13);
    doc.text(fmtAmt(Math.abs(netFlow)) + (netFlow >= 0 ? '  SURPLUS' : '  DEFICIT'), pageW-margin-4, y+12, {align:'right'});
    doc.setFontSize(7.5); doc.setFont('helvetica','normal');
    doc.text(`(Total Deposits ${fmtAmt(totalDep)}  ‚àí  Total Withdrawals ${fmtAmt(totalWdr)})`, pageW/2, y+16, {align:'center'});
    y += 24;

    // ‚îÄ‚îÄ FOOTER on each page ‚îÄ‚îÄ
    const totalPages = doc.getNumberOfPages();
    for (let p = 1; p <= totalPages; p++) {
        doc.setPage(p);
        doc.setFillColor(44,62,80);
        doc.rect(0, pageH-7, pageW, 7, 'F');
        doc.setTextColor(180,180,180); doc.setFontSize(5.5); doc.setFont('helvetica','normal');
        doc.text('SHOP EBENEZER ‚Äî Confidential Daily Report', margin, pageH-2.5);
        doc.text(`Page ${p} of ${totalPages}`, pageW-margin, pageH-2.5, {align:'right'});
        doc.text(displayDate, pageW/2, pageH-2.5, {align:'center'});
    }

    // ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
    doc.save(`ShopEbenezer_DailySummary_${reportDate}.pdf`);
    ledger.toast('üìÑ Daily PDF report downloaded successfully!');
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
